/*!
 *  opentok-whiteboard (http://github.com/aullman/opentok-whiteboard)
 *  
 *  Shared Whiteboard that works with OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
var OpenTokWhiteboard=angular.module("opentok-whiteboard",["opentok"]).directive("otWhiteboard",["OTSession","$window",function(o,e){return{restrict:"E",template:'<canvas></canvas><div class="OT_panel"><input type="button" ng-class="{OT_color: true, OT_selected: c[\'background-color\'] === color}" ng-repeat="c in colors" ng-style="c" ng-click="changeColor(c)"></input><input type="button" ng-click="erase()" ng-class="{OT_erase: true, OT_selected: erasing}" value="Eraser"></input><input type="button" ng-click="capture()" class="OT_capture" value="{{captureText}}"></input><input type="button" ng-click="undo()" class="OT_capture" value="Undo"></input><input type="button" ng-click="redo()" class="OT_capture" value="Redo"></input><input type="button" ng-click="clear()" class="OT_clear" value="Clear"></input>',link:function(t,n,a){var i,r=n.context.querySelector("canvas"),c=(n.context.querySelector("select"),n.context.querySelector("input"),{dragging:!1}),s=0,u=0,p=[],d=[],l=[],h=[],g=/(iPad|iPhone|iPod)/g.test(navigator.userAgent);e.paper.setup(r),t.colors=[{"background-color":"black"},{"background-color":"blue"},{"background-color":"red"},{"background-color":"green"},{"background-color":"orange"},{"background-color":"purple"},{"background-color":"brown"}],t.captureText=g?"Email":"Capture",t.strokeCap="round",t.strokeJoin="round",r.width=a.width||n.width(),r.height=a.height||n.height();var f=function(){e.paper.project.clear(),e.paper.view.update()};t.changeColor=function(o){t.color=o["background-color"],t.lineWidth=2,t.erasing=!1},t.changeColor(t.colors[Math.floor(Math.random()*t.colors.length)]),t.clear=function(){f(),o.session&&o.session.signal({type:"otWhiteboard_clear"})},t.erase=function(){t.lineWidth=50,t.erasing=!0},t.capture=function(){g?window.location.href="mailto:?subject=Whiteboard&Body=<img src='"+r.toDataURL("image/png")+"'>":window.open(r.toDataURL("image/png"))},t.undo=function(){if(p.length){var o=p.pop();m(o),d.push(o),W("otWhiteboard_undo",o)}};var m=function(o){o.visible=!1,e.paper.view.update()};t.redo=function(){if(d.length){var o=d.pop();b(o),p.push(o),W("otWhiteboard_redo",o)}};var v,b=function(o){o.visible=!0,e.paper.view.update()},w=function(o,n){console.log(o,n),void 0!==typeof n&&(window.path=new e.paper.Path,path.strokeColor=o.color,path.strokeWidth=t.lineWidth,path.strokeCap=t.strokeCap,path.strokeJoin=t.strokeJoin,mode=t.erasing?"pen":"eraser","pen"==mode&&(path.blendMode="destination-out"),s=new e.paper.Point(o.fromX,o.fromY),path.moveTo(s)),window.path.add(o.toX,o.toY),l.push(o),void 0!==typeof n&&(window.path.smooth(),c.dragging=!1,u&&(s=l.length,p.push(window.path),u=0))},k=function(o){o.forEach(function(o){w(o,!0),l.push(o)})},y=function(e,t,n){for(var a=t.slice(),i=function(o){o&&TB.error(o)};a.length;){var r=a.splice(0,Math.min(a.length,32)),c={type:e,data:JSON.stringify(r)};n&&(c.to=n),o.session.signal(c,i)}},W=function(e,t){o.session&&(h.push(t),v||(v=setTimeout(function(){y(e,h),h=[],v=null},100)))};angular.element(document).on("keyup",function(o){o.ctrlKey&&(90===o.keyCode&&t.undo(),89===o.keyCode&&t.redo())}),angular.element(r).on("mousedown mousemove mouseup mouseout touchstart touchmove touchend touchcancel",function(a){if("mousemove"!==a.type&&"touchmove"!==a.type&&"mouseout"!==a.type||c.dragging){a.preventDefault();var i,s=angular.element(r).offset(),h=r.width/n.width(),g=r.height/n.height(),f=a.offsetX||a.originalEvent.pageX-s.left||a.originalEvent.touches[0].pageX-s.left,m=a.offsetY||a.originalEvent.pageY-s.top||a.originalEvent.touches[0].pageY-s.top,v=f*h,b=m*g,k=t.erasing?"pen":"eraser";switch(a.type){case"mousedown":case"touchstart":c.dragging=!0,c.lastX=v,c.lastY=b,window.path&&(window.path.selected=!1),window.path=new e.paper.Path,path.strokeColor=t.color,path.strokeWidth=t.lineWidth,path.strokeCap=t.strokeCap,path.strokeJoin=t.strokeJoin,"pen"==k&&(path.blendMode="destination-out"),i=new e.paper.Point(v,b),path.moveTo(i);break;case"mousemove":case"touchmove":if(f=a.offsetX||a.originalEvent.pageX-s.left||a.originalEvent.touches[0].pageX-s.left,m=a.offsetY||a.originalEvent.pageY-s.top||a.originalEvent.touches[0].pageY-s.top,v=f*h,b=m*g,c.dragging){var y={id:o.session&&o.session.connection&&o.session.connection.connectionId,fromX:c.lastX,fromY:c.lastY,toX:v,toY:b,mode:k,color:t.color,lineWidth:t.lineWidth,show:1};u++,d=[],w(y),l.push(y),c.lastX=v,c.lastY=b,W("otWhiteboard_update",y)}break;case"touchcancel":case"mouseup":case"touchend":case"mouseout":window.path.smooth(),c.dragging=!1,u&&(i=l.length,p.push(window.path),u=0)}}}),o.session&&o.session.on({"signal:otWhiteboard_update":function(e){e.from.connectionId!==o.session.connection.connectionId&&(k(JSON.parse(e.data)),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_undo":function(e){e.from.connectionId!==o.session.connection.connectionId&&(JSON.parse(e.data).forEach(function(o){m(o)}),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_redo":function(e){e.from.connectionId!==o.session.connection.connectionId&&(JSON.parse(e.data).forEach(function(o){b(o)}),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_history":function(o){i&&i!==o.from.connectionId||(i=o.from.connectionId,k(JSON.parse(o.data)),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_clear":function(e){e.from.connectionId!==o.session.connection.connectionId&&f()},connectionCreated:function(e){l.length>0&&e.connection.connectionId!==o.session.connection.connectionId&&y("otWhiteboard_history",l,e.connection)}})}}}]);