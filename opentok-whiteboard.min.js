/*!
 *  opentok-whiteboard (http://github.com/aullman/opentok-whiteboard)
 *  
 *  Shared Whiteboard that works with OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
var OpenTokWhiteboard=angular.module("opentok-whiteboard",["opentok"]).directive("otWhiteboard",["OTSession","$window",function(o){return{restrict:"E",template:'<canvas></canvas><div class="OT_panel"><input type="button" ng-class="{OT_color: true, OT_selected: c[\'background-color\'] === color}" ng-repeat="c in colors" ng-style="c" ng-click="changeColor(c)"></input><input type="button" ng-click="clear()" class="OT_clear" value="Clear"></input>',link:function(n,e,t){var c,r,i=e.context.querySelector("canvas"),a=(e.context.querySelector("select"),e.context.querySelector("input"),{dragging:!1}),s=[],l=2,u=[];n.colors=[{"background-color":"black"},{"background-color":"blue"},{"background-color":"red"},{"background-color":"green"},{"background-color":"orange"},{"background-color":"purple"},{"background-color":"brown"}],n.color=n.colors[Math.floor(Math.random()*n.colors.length)]["background-color"],i.width=t.width||e.width(),i.height=t.height||e.height();var d=function(){c.save(),c.setTransform(1,0,0,1,0,0),c.clearRect(0,0,i.width,i.height),c.restore(),s=[]};n.changeColor=function(o){n.color=o["background-color"]},n.clear=function(){d(),o.session&&o.session.signal({type:"otWhiteboard_clear"})};var g,h=function(o){c||(c=i.getContext("2d"),c.lineCap="round",c.fillStyle="solid"),c.strokeStyle=o.color,c.lineWidth=o.lineWidth,c.beginPath(),c.moveTo(o.fromX,o.fromY),c.lineTo(o.toX,o.toY),c.stroke(),c.closePath(),s.push(o)},f=function(o){o.forEach(function(o){h(o)})},p=function(n,e,t){for(var c=0;c<e.length;c++){for(var r=[];c<e.length&&JSON.stringify(r).length<5e3;c++)r.push(e[c]);var i={type:n,data:JSON.stringify(r)};t&&(i.to=t),o.session.signal(i)}},m=function(n){o.session&&(u.push(n),g||(g=setTimeout(function(){p("otWhiteboard_update",u),u=[],g=null},100)))};angular.element(i).on("mousedown mousemove mouseup mouseout touchstart touchmove touchend",function(t){if("mousemove"!==t.type||a.dragging){t.preventDefault();var c=angular.element(i).offset(),r=i.width/e.width(),s=i.height/e.height(),u=t.offsetX||t.originalEvent.pageX-c.left,d=t.offsetY||t.originalEvent.pageY-c.top,g=u*r,f=d*s;switch(t.type){case"mousedown":case"touchstart":a.dragging=!0,a.lastX=g,a.lastY=f;break;case"mousemove":case"touchmove":if(a.dragging){var p={id:o.session&&o.session.connection&&o.session.connection.connectionId,fromX:a.lastX,fromY:a.lastY,toX:g,toY:f,color:n.color,lineWidth:l};h(p),a.lastX=g,a.lastY=f,m(p)}break;case"mouseup":case"touchend":case"mouseout":a.dragging=!1}}}),o.session&&o.session.on({"signal:otWhiteboard_update":function(n){n.from.connectionId!==o.session.connection.connectionId&&f(JSON.parse(n.data))},"signal:otWhiteboard_history":function(o){r&&r!==o.from.connectionId||(r=o.from.connectionId,f(JSON.parse(o.data)))},"signal:otWhiteboard_clear":function(n){n.from.connectionId!==o.session.connection.connectionId&&d()},connectionCreated:function(n){s.length>0&&n.connection.connectionId!==o.session.connection.connectionId&&p("otWhiteboard_history",s,n.connection)}})}}}]);