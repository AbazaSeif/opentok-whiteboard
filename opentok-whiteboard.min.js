/*!
 *  opentok-whiteboard (http://github.com/aullman/opentok-whiteboard)
 *
 *  Shared Whiteboard that works with OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
var OpenTokWhiteboard=angular.module("opentok-whiteboard",["opentok"]).directive("otWhiteboard",["OTSession","$window",function(e,o){return{restrict:"E",template:'<canvas hidpi="off"></canvas><div class="OT_panel"><input type="button" ng-class="{OT_color: true, OT_selected: c[\'background-color\'] === color}" ng-repeat="c in colors" ng-style="c" ng-click="changeColor(c)"></input><input type="button" ng-click="erase()" ng-class="{OT_erase: true, OT_selected: erasing}" value="Eraser"></input><input type="button" ng-click="capture()" class="OT_capture" value="{{captureText}}"></input><input type="button" ng-click="undo()" class="OT_capture" value="Undo"></input><input type="button" ng-click="redo()" class="OT_capture" value="Redo"></input><input type="button" ng-click="clear()" class="OT_clear" value="Clear"></input>',link:function(t,n,i){var a,r=n.context.querySelector("canvas"),c=(n.context.querySelector("select"),n.context.querySelector("input"),{dragging:!1}),s=0,u=[],d=[],l=[],p=[],g=[],h=/(iPad|iPhone|iPod)/g.test(navigator.userAgent);o.paper.setup(r),r.width=i.width||n.width(),r.height=i.height||n.height(),o.paper.view.viewSize=new o.paper.Size(r.width,r.height),o.paper.view.draw(),t.colors=[{"background-color":"black"},{"background-color":"blue"},{"background-color":"red"},{"background-color":"green"},{"background-color":"orange"},{"background-color":"purple"},{"background-color":"brown"}],t.captureText=h?"Email":"Capture",t.strokeCap="round",t.strokeJoin="round",t.lineWidth=2;var f=function(){o.paper.project.clear(),o.paper.view.update(),p=[],l=[],u=[],d=[],s=0};t.changeColor=function(e){t.color=e["background-color"],t.erasing=!1},t.changeColor(t.colors[Math.floor(Math.random()*t.colors.length)]),t.clear=function(){f(),e.session&&e.session.signal({type:"otWhiteboard_clear"})},t.erase=function(){t.erasing=!0},t.capture=function(){h?o.location.href="mailto:?subject=Whiteboard&Body=<img src='"+r.toDataURL("image/png")+"'>":o.open(r.toDataURL("image/png"))},t.undo=function(){if(u.length){var e=u.pop();v(e),W("otWhiteboard_undo",e)}};var v=function(e){d.push(e),l.forEach(function(t){t.uuid===e&&(t.visible=!1,o.paper.view.update())}),p.forEach(function(o){o.uuid===e&&(o.visible=!1)})};t.redo=function(){if(d.length){var e=d.pop();m(e),W("otWhiteboard_redo",e)}};var b,m=function(e){u.push(e),l.forEach(function(t){t.uuid===e&&(t.visible=!0,o.paper.view.update())}),p.forEach(function(o){o.uuid===e&&(o.visible=!0)})},k=function(e){switch(p.push(e),e.event){case"start":var n=new o.paper.Path;n.selected=!1,n.strokeColor=e.color,n.strokeWidth=t.lineWidth,n.strokeCap=t.strokeCap,n.strokeJoin=t.strokeJoin,n.uuid=e.uuid,"eraser"===e.mode&&(n.blendMode="destination-out",n.strokeWidth=50),angular.isDefined(e.visible)&&(n.visible=e.visible);var i=new o.paper.Point(e.fromX,e.fromY);n.moveTo(i),o.paper.view.draw(),l.push(n);break;case"drag":l.forEach(function(t){t.uuid===e.uuid&&(t.add(e.toX,e.toY),o.paper.view.draw())});break;case"end":l.forEach(function(t){t.uuid===e.uuid&&(u.push(t.uuid),t.simplify(),o.paper.view.draw())})}},w=function(e){e.forEach(function(e){k(e)})},y=function(o,t,n){for(var i=t.slice(),a=function(e){e&&TB.error(e)};i.length;){var r=i.splice(0,Math.min(i.length,32)),c={type:o,data:JSON.stringify(r)};n&&(c.to=n),e.session.signal(c,a)}},W=function(o,t,n){e.session&&(g.push(t),b||(b=setTimeout(function(){y(o,g,n),g=[],b=null},100)))},_=function(){e.session.signal({type:"otWhiteboard_request_history"})};angular.element(document).on("keyup",function(e){e.ctrlKey&&(90===e.keyCode&&t.undo(),89===e.keyCode&&t.redo())}),angular.element(r).on("mousedown mousemove mouseup mouseout touchstart touchmove touchend touchcancel",function(o){if("mousemove"!==o.type&&"touchmove"!==o.type&&"mouseout"!==o.type||c.dragging){o.preventDefault();var i,a=angular.element(r).offset(),u=r.width/n.width(),l=r.height/n.height(),p=o.offsetX||o.originalEvent.pageX-a.left||o.originalEvent.touches[0].pageX-a.left,g=o.offsetY||o.originalEvent.pageY-a.top||o.originalEvent.touches[0].pageY-a.top,h=p*u,f=g*l,v=t.erasing?"eraser":"pen";switch(o.type){case"mousedown":case"touchstart":c.dragging=!0,c.lastX=h,c.lastY=f,c.uuid=parseInt(h)+parseInt(f)+Math.random().toString(36).substring(2),i={id:e.session&&e.session.connection&&e.session.connection.connectionId,uuid:c.uuid,fromX:c.lastX,fromY:c.lastY,mode:v,color:t.color,event:"start"},k(i),W("otWhiteboard_update",i);break;case"mousemove":case"touchmove":p=o.offsetX||o.originalEvent.pageX-a.left||o.originalEvent.touches[0].pageX-a.left,g=o.offsetY||o.originalEvent.pageY-a.top||o.originalEvent.touches[0].pageY-a.top,h=p*u,f=g*l,c.dragging&&(i={id:e.session&&e.session.connection&&e.session.connection.connectionId,uuid:c.uuid,fromX:c.lastX,fromY:c.lastY,toX:h,toY:f,event:"drag"},s++,d=[],c.lastX=h,c.lastY=f,k(i),W("otWhiteboard_update",i));break;case"touchcancel":case"mouseup":case"touchend":case"mouseout":s&&(i={id:e.session&&e.session.connection&&e.session.connection.connectionId,uuid:c.uuid,event:"end"},k(i),W("otWhiteboard_update",i)),c.dragging=!1,c.uuid=!1}}}),e.session&&(e.session.isConnected()&&_(),e.session.on({sessionConnected:function(){_()},"signal:otWhiteboard_update":function(o){o.from.connectionId!==e.session.connection.connectionId&&(w(JSON.parse(o.data)),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_undo":function(o){o.from.connectionId!==e.session.connection.connectionId&&(JSON.parse(o.data).forEach(function(e){v(e)}),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_redo":function(o){o.from.connectionId!==e.session.connection.connectionId&&(JSON.parse(o.data).forEach(function(e){m(e)}),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_history":function(e){a&&a!==e.from.connectionId||(a=e.from.connectionId,w(JSON.parse(e.data)),t.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_clear":function(o){o.from.connectionId!==e.session.connection.connectionId&&f()},"signal:otWhiteboard_request_history":function(e){p.length>0&&y("otWhiteboard_history",p,e.connection)}}))}}}]);